#!/bin/bash
UPDATE_GRUB="$(dirname $0)/update-grub"
CONFIG=/proc/config.gz
if test ! -e "$CONFIG"; then
  echo "Current kernel was not built with /proc/config.gz support"
  exit 1
fi
if test ! -e "$UPDATE_GRUB"; then
  echo "Unable to find $UPDATE_GRUB"
  exit 2
fi
ZCAT="$(which zcat)"
if test -z "$ZCAT"; then
  echo "No zcat in path"
  exit 3
fi

nice -n 19 $ZCAT $CONFIG | genkernel all --kernel-config=/dev/stdin --oldconfig --makeopts=-j$(nproc) --loglevel=2 && emerge @module-rebuild && $UPDATE_GRUB
